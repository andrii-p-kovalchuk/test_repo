/* groovylint-disable DuplicateStringLiteral, LineLength */
pipeline {
    agent any
    stages {
        stage('Terraform format') {
            steps {
                echo 'Terraform format'
                sh '''cd ./terraform
                terraform fmt && terraform validate'''
            }
        }
        stage('Terraform init') {
            steps {
                echo 'Terraform init'
                sh '''cd ./terraform
                terraform init'''
            }
        }
        stage('Terraform Plan') {
            steps {
                echo 'Terraform plan'
                sh '''cd ./terraform
                terraform plan'''
            }
        }
        stage('Terraform apply') {
            input {
                message 'Ready to apply?'
                ok 'Yes'
                parameters {
                    booleanParam defaultValue: false, description: 'Do you really want to apply infrastructure (By default "No" )?', name: 'APPLY'
                }
            }
            steps {
                // parameters {
                //     booleanParam defaultValue: false, description: 'Do you really want to apply infrastructure (By default "No" )?', name: 'APPLY'
                // }
                when {
                    allOf {
                        environment ignoreCase: true, name: 'APPLY', value: 'true'
                    }
                }
                script {
                    dir('/var/lib/jenkins/workspace/terraform_start/terraform') {
                        echo 'Terraform apply'
                        sh 'terraform apply -auto-approve'}
                }
            }
        }
    }
}
